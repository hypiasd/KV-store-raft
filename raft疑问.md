## 一、整体流程

1、客户端如何与集群通信？如果流程是事先已知一个ip，若该ip不是领导者则重定向给领导者，那么如果该ip挂了呢？这个事先已知的ip就相当于代理？

>解答：客户端可以通过与Raft集群中的任何服务器通信来与集群进行交互。通常，客户端会选择与已知的服务器列表中的某个服务器建立连接，并向其发送请求。
>
>如果客户端连接的服务器不是领导者，服务器可以向客户端返回一个重定向（Redirect）响应，包含领导者的地址信息。客户端在收到重定向响应后，会更新自己的连接目标，然后重新发送请求给领导者。
>
>但是，如果客户端事先已知的服务器挂了，即无法建立连接或无法收到响应，客户端可以根据自身的实现策略来处理。一种常见的策略是进行重试，尝试连接其他已知的服务器，直到成功建立连接并与领导者进行交互。客户端可以维护一个服务器列表或通过其他机制动态获取可用服务器的地址。
>
>在这种情况下，事先已知的IP可以被看作是一个代理，它起到了将客户端引导到正确的领导者的作用。如果事先已知的IP挂了，客户端需要通过其他方式找到可用的服务器来进行连接和交互。这种方式可以提高系统的可用性和容错性，确保客户端能够与Raft集群正常通信。

## 二、领导人选举

1、投票过程中候选人如何知道自己的票数达到半数以上？如果是启动集群时已知的，那么如果中间有某些节点挂掉时又该如何确定呢？

> 解答：在Raft协议中，节点在启动时需要配置一个初始的集群成员列表或者通过其他机制动态地获取可用的服务器列表。这个配置中包含了集群中的节点信息，节点通过与列表中的其他节点进行通信来参与Raft协议的工作。对于中间有某些节点挂掉的情况，Raft协议具备容错性。如果在选举过程中某些节点无法响应或者挂掉，候选人可以通过超时等待更长时间以获得更多的选票。如果候选人无法获得超过半数的选票，那么选举将会失败，候选人需要等待一段时间后再次发起新一轮的选举。

2、超时时间有几种？

> 解答：在Raft中，存在不同的超时时间，包括选举超时（election timeout）和心跳超时（heartbeat timeout）。
>
> 1. 心跳超时是指领导者发送心跳消息的间隔时间。领导者周期性地向跟随者发送心跳消息，以维持与跟随者的联系，并表明自己的继续存在。跟随者在收到心跳消息后会响应，并表明自己的活跃状态。如果领导者在心跳超时时间内没有收到跟随者的响应，它会认为跟随者可能出现了故障或不可达，并可能触发重新选举流程。
> 
>2. 选举超时是指跟随者和候选者设置的超时时间，在该时间内如果没有收到来自领导者的有效消息，跟随者会转变为候选者并发起选举。候选者在选举超时时间内需要等待其他节点的选票，如果在该时间内没有获得足够多的选票，候选者会认为选举失败，并重新开始一个新的选举周期。

3、两种超时时间是固定的吗？

> 解答：对于选举超时时间，Raft协议通常会采用随机化的策略来避免多个候选人同时发起选举。每个节点会在一个预定义的时间范围内随机选择一个选举超时时间，通常取值在几百毫秒到一秒之间。通过引入随机化，可以防止多个节点在相同时间内开始选举，从而减少竞争和冲突。
>
> 至于心跳超时时间，它是由领导者节点来确定并发送心跳消息的时间间隔。心跳超时时间一般比选举超时时间短，通常取值在几十毫秒到几百毫秒之间。心跳超时时间通常是固定的，不会随机变化。
>
> 需要注意的是，具体的超时时间设置是根据实现和应用的需求而定的，可以根据系统的性能、网络延迟和负载等因素进行调整。超时时间的选择应该在充分考虑系统的可靠性和性能之间的平衡。

4、如果还没选出leader时，客户端发来请求，这时候该如何处理？

> 解答：会直接忽略，客户端可以等待一段时间后重新发送请求。

5、收到投票请求时，选举超时是否会重置？

> 解答：如果接收了投票请求，即为其他候选人投票，则会重置，且任期更新为投票对象的任期。如果拒绝投票，则不会重置

## 三、日志复制

1、领导人并行地发起附加条目给其他服务器，并行是多线程？

> 解答：在Raft协议中，领导者通过并行地向其他服务器发送附加条目来复制日志。"并行"在这里指的是在相同的时间段内，领导者可以同时向多个服务器发送附加条目，而不是按照顺序一个接一个地发送。这种并行操作可以通过多线程实现，其中每个线程负责向一个服务器发送附加条目。通过并行处理，领导者可以提高复制日志的效率和吞吐量。

2、跟随者什么时候会拒绝复制，什么时候会被强制复制？

> 解答：如果一个节点成为领导者，但缺失了先前任期的日志条目，而其他节点具有这些日志条目，那么当它尝试向其他节点复制日志时，其他节点会拒绝复制请求，因为它们的日志已经包含了先前任期的条目，而新的领导者的任期号更大。这将导致新的领导者无法维持与其他节点的日志一致性，并且会触发新一轮的选举。
>
> 跟随者被强制复制的情况包括以下情形：
>
> 1. 如果领导者发现自己的日志和跟随者的日志存在不一致，即领导者的日志在某个索引处与跟随者的日志不同步，那么领导者会将缺失的日志条目发送给跟随者，强制使它们达到一致。
>
> 2. 如果领导者的当前任期比跟随者的任期大，跟随者会将自己的任期更新为领导者的任期，并清空自己的日志，然后跟随者将接受来自领导者的所有日志条目进行复制。这是为了确保领导者的日志成为集群中的最新状态，跟随者需要放弃自己的日志并接受领导者的日志。

3、强制与领导者保持一致不会使得一部分日志丢失吗

> 解答：在Raft协议中，强制跟随者与领导者保持一致的过程中，有可能出现部分日志的丢失。当领导者发现自己的日志与跟随者的日志不一致时，它会尝试将缺失的日志条目发送给跟随者。然而，在发送过程中，由于网络故障或其他原因，这些日志条目可能无法完全到达跟随者。
>
> 当领导者重新选举或崩溃时，新的领导者可能会丢失未复制给所有跟随者的日志条目。这是因为新的领导者只能依赖于先前已经复制给跟随者的日志条目。未复制的日志条目将会丢失，因为之前的领导者可能已经提交了这些日志条目，但新的领导者无法获取到它们。
>
> 因此，在Raft协议中，虽然尽力保证日志的复制和一致性，但在特定情况下仍然有可能发生部分日志的丢失。为了减少丢失的可能性，Raft协议使用了持久化日志和日志的复制机制，以最大程度地确保日志的一致性和可靠性。

4、如果领导者提交了一个日志，它还会对还未复制的跟随者继续复制日志吗？

> 解答：在Raft协议中，一旦领导者将日志条目提交到自己的本地日志中，并将其应用到状态机，它不会继续对还未复制该日志条目的跟随者进行复制。
>
> 当领导者提交一个日志条目后，它会等待大多数（大于一半）的跟随者确认已经成功复制了该日志条目。一旦领导者收到了足够多的确认，它就会将该日志条目视为已提交，并将其应用到状态机，从而改变系统的状态。
>
> 对于还未复制该日志条目的跟随者，当它们接收到领导者的下一个心跳或附加日志请求时，它们会发现自己与领导者的日志不一致，并会请求缺失的日志条目。领导者会根据跟随者的请求重新复制缺失的日志条目，以保持日志的一致性。
>
> 总结来说，一旦领导者将日志条目提交并应用到状态机，它不会主动对还未复制该日志条目的跟随者进行复制。而是等待跟随者在下一次的请求中发现缺失的日志条目，并重新复制这些缺失的日志条目，以保持日志的一致性。

5、如果一个请求未被commit，那么这个请求是无效的吗？

> 解答：是的

6、挂了的节点重启后，如何确定commit到那个index了？

> 解答：该节点会先与leader保持相同的日志，然后从0开始恢复其状态，这个过程可能很费时。加入checkpoint的机制可以改善（待续。。。）

## 四、安全性

1、比较条目时，有没有可能出现任期号更大，索引号更大的一方其实丢失了一部分任期的条目，比如当前任期为9，但是缺失了任期8的日志？

> 解答：不存在这种情况，如果缺失了任期8，在选举的时候含有任期8日志的跟随者是不会投票的，及时当选了领导者，含有任期8的跟随者会因为心跳超时成为候选人，从而夺回领导者的位置。倘若含任期8的节点挂了，且集群收到了新的请求，那么恢复后任期8这个日志会被覆盖，因为要与领导者保持一致性。

2、当有节点挂了，但是领导者还是不断向该节点发送心跳，这是否会消耗不必要的资源？

> 解答：确实会有一定的资源浪费

3、